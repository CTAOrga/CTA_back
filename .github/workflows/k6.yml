name: k6 load tests - backend

on:
  push:
    branches: [main, develop, k6-fix]
  pull_request:
    branches: [main, develop, k6-fix]

jobs:
  k6-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Docker Compose
        run: docker version

      - name: Levantar stack de Docker
        run: |
          docker compose -f devops/compose.yml up -d backend mysql

      # ðŸ‘‡ Esperamos a que MySQL estÃ© OK
      - name: Wait for MySQL
        run: |
          echo "Esperando healthcheck de MySQL..."
          for i in {1..30}; do
            docker exec mysql-container mysqladmin ping -h localhost -proot --silent && break
            sleep 2
          done

      # ðŸ‘‡ Esperamos a que el backend responda
      - name: Wait for backend
        run: |
          echo "Esperando que el backend responda en /health..."
          for i in {1..30}; do
            http_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/v1/health || true)
            if [ "$http_code" = "200" ]; then
              echo "Backend OK!"
              break
            fi
            sleep 2
          done

      - name: Set up k6
        uses: grafana/setup-k6-action@v1

      - name: k6 - load listings
        run: |
          API_BASE_URL=http://localhost:8000/api/v1 \
          k6 run --summary-export=summary-load-listings.json k6/load-listings.js

      - name: k6 - spyke listings
        run: |
          API_BASE_URL=http://localhost:8000/api/v1 \
          k6 run --summary-export=summary-spyke-listings.json k6/spyke-listings.js

      - name: k6 - stress listings
        run: |
          API_BASE_URL=http://localhost:8000/api/v1 \
          k6 run --summary-export=summary-stress-listings.json k6/stress-listings.js
